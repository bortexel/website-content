## Сообщения о ценах

На сервере можно просматривать цены на предметы в магазинах, чтобы быстро находить места, где эти предметы купить. Раньше эта информация обновлялась администрацией, но сейчас это можно делать самостоятельно. В этой статье мы рассмотрим, как это происходит.

Вся информация о ценах хранится в одном месте, из которого её берёт как бот Руслан на нашем Discord сервере, так и сайт. Управление этой информацией происходит с помощью команд в игре.

### Выбираем магазин

Когда вы хотите обновить информацию о ценах в магазине, в первую очередь нужно выбрать собственно магазин. Делается это с помощью команды `/er select <id>`, где на месте `<id>` должен быть идентификатор магазина. Его можно узнать на сайте, перейдя на страницу магазина. Идентификатор будет в её адресе. Например, если магазину соответствует страница `https://bortexel.net/shops/1`, то его идентификатор - `1`, и ввести нужно команду `/er select 1`. Если у вас есть проблемы с определением идентификатора, то задавайте вопрос в Discord, мы подскажем.

### Сохраняем цены

Запись цен для каждого предмета происходит с помощью команды `/er create <предмет> <в наличии> <стоимость> [количество]`. Разберём отдельно каждый из параметров.

* `предмет` - идентификатор предмета. Он может не совпадать с идентификатором предмета в Minecraft. Доступны не все предметы, вы можете выбрать только из тех, что будут предложены в подсказке к команде. Для книг зачарования идентификатор будет иметь формат `e_идентификатор`, где `идентификатор` - ID зачарования, например, `e_mending` - "Починка".

* `в наличии` - оценка количества предметов в наличии. Значение определяется по следующей схеме:

  * `0` - Нет в наличии или предметов меньше, чем минимальное количество, которое можно купить в данном магазине (например, в наличии 1 алмаз, а продаётся "2 алмаза за 1 ед. валюты").
  
  * `1` - В наличии 1-2 слота (например, в наличии 4 алмаза, при продаже двух за раз)
   
  * `2` - Достаточно для покупателя в лице среднестатистического игрока. Может быть как при нескольких доступных слотах, если предмет редкий, так и при большом количестве в остальных случаях.
  
  * `3` - Много. Количество предметов в наличии превышает потребности среднестатистического игрока.

* `стоимость` - стоимость предмета за N ед. товара, где N по умолчанию = 1. Не путать со стоимостью за "слот".

* `количество` - позволяет переопределить N из предыдущего пункта. Если не указано, то N = 1.

Вы можете использовать эту команду несколько раз, в таком случае последнее сообщение будет перезаписано.

### Простые правила

Мы всё же хотим сохранить порядок в списках средних цен. Давая владельцам магазинов возможность влиять на эти списки, мы ожидаем, что они будут объективны, будут указывать достоверную информацию. Мы всё равно будем обходить магазины, записывая стоимости предметов. Если будет замечено, что владелец предприятия указывает недостоверную информацию, у него будет отобрана возможность обновлять стоимость предмета в системе.

### Некоторые особенности

#### Ревизоры

По умолчанию создавать сообщения о ценах в магазине может только его владелец. Технически предусмотрена возможность дать отдельным людям право на создание сообщений о ценах в любых магазинах, даже им не принадлежащих.

#### Стадии

Все сообщения о ценах объединяются в группы, называемые *стадиями*. Эти группы соответствуют определённым отрезкам времени длиной в 7 дней. Когда вы используете `/er create`, новое сообщение о стоимости связывается с последней стадией. Такая система была нужна в своё время, чтобы организовать рассчёт средних цен в определённый промежуток времени, но с упразднением минимальных цен, она всё равно осталась. С ней связано несколько особенностей.

Когда кто-либо запрашивает список цен на *определённый* предмет, сервер ищет последнюю стадию, на которой была записана стоимость этого предмета. Поэтому, если вы не будете обновлять информацию о стоимости предмета в магазине долгое по сравнению с длительностью стадии время, система всё равно будет показывать ваш магазин, но только в том случае, если кто-либо ещё за это время не запишет другую стоимость на этот же предмет.

Отсюда следует, что оптимальный интервал между обновлениями информации о ценах - длительность стадии, т.е. 7 дней.

К слову, старая стадия сменяется новой каждую пятницу в 22:00 по МСК. В это же время происходит перерассчёт средних цен.

#### Работа с API

Получать список сообщений о ценах можно через [открытый REST API](https://docs.bortexel.ru/rest-api/endpoints/price-reports). Создание сообщений через API пока недоступно.